# circle.yml
machine:
  # Install eb need python
  python:
    version: 2.7
  services:
    - docker
dependencies:
  pre:
    - |
      sudo service docker stop
      test $(docker --version | awk '{ print $3 }' | head -c3) != "1.6" && {
        sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.6.2-circleci';
        sudo chmod 0755 /usr/bin/docker;
      }
    - sudo service docker start
    - sudo pip install awsebcli --ignore-installed setuptools
  override:
    - docker build -t docker_node .
    #Because circle ci's docker is not lxc not run docker exec
    - docker run --rm -v /usr/local/bin:/target jpetazzo/nsenter
test:
  override:
        #使用 curl 測試 docker 是否有順利執行 node
    - docker run -d -p 3000:3000 --name docker_node_run docker_node
    #- ./docker_enter.sh docker_node_run
    - cd app; ./node_modules/.bin/mocha
    - docker exec -i docker_node_run bash -c "./node_modules/.bin/mocha"
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000
# 新增一筆部署腳本
deployment:
  production:
    branch: master
    commands:
      - bash ./setup-eb.sh
      - eb deploy env-production